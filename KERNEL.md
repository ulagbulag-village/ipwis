# IPWIS 커널

IPWIS 커널의 구조를 한국어 문서로 정리하였다.

## 주요 컴포넌트

`wasmtime` 엔진에 의해 제어되는 기능들은 배제하였다.

* Scheduler: 여러 `Task`를 생성하고 제어할 수 있는 커널의 핵심 기능이다.
    - 내부적으로는 `wasmtime` 엔진의 구현을 그대로 따른다.
    - Task: 스케쥴러의 제어를 받는 IPWIS 프로세서
* Interrupt Handler: **미리 정의한** 인터럽트 상황을 해결할 수 있는 기능이다.
    - 사용자가 정의한 `syscall` 구현이 여기에 속한다.
    - 입출력 구성은 `IPIIS`와 유사하다.
        - 실제로 커널이 지원하지 않는 `syscall`을 호출하는 경우 `IPIIS` 모듈을 통해 커널 외부에서 호출할 수 있다.
    - **마이크로커널: IPWIS 커널에서는 별도로 인터럽트 핸들러를 정의하지 않는다.**
        - 대신 `wasmtaime` 엔진 내 모듈 바인딩으로 필수적인 `syscall`을 구현한다.
        - 단, IPWIS 런타임에는 커널에 IPIIS 모듈이 기본적으로 제공된다.
            - **IPIIS 모듈을 제거하는 경우 커널 외부와 상호작용할 수 있는 방법이 없다. 즉, IPIIS 모듈은 일반적인 프로세스가 커널 외부와 상호작용할 수 있는 유일한 접근법이다.**
        - 성능 향상을 위해 별도로 모듈을 탑재할 수 있다.
            - 예를 들어, IPWIS 커널과 IPSIS 런타임이 리소스를 공유하는 경우, IPSIS 모듈을 IPWIS 커널에 탑재하는 것으로 불필요한 IPIIS 통신 오버헤드를 줄일 수 있다.
            - 단, 인터럽트 모드는 커널 외부의 리소스에 접근할 권한이 있으므로 **보안에 각별히 신경써야 한다.**
    - 인터럽트 제어는 `Task`로 구현한다.
* Resource Manager: 하드웨어 자원 관리자.
    - CPU, GPU, 메모리, 네트워크 자원 등의 상태를 조회할 수 있다.
    - **수행하려는 프로그램이 감당 가능한지 예측한다.**
        - 만약 커널이 자체 리소스로 주어진 프로그램을 감당할 수 없다고 판단하면 그보다 리소스가 많은 커널에 `IPIIS`를 통해 명령해야 할 것이다.

## 의존성 트리

IPWIS `Task` 호출을 위한 프로토콜 및 포맷이다.

* IPI 메타데이터
    - 호출자, 피호출자 및 서명
    - 생성 시각
* 입출력 데이터
    - Key
    - Type
    - Value (Path)
* 프로그램 경로
* 서브프로그램
    - 예약 프로그램
    - 자식 프로그램
    - 예외 프로그램
* 자원 요구사항
    - CPU, GPU, 메모리, 네트워크 등 하드웨어 자원 최소 요구사항
    - **최대 호출 시간**: 시간을 넘겨버리는 경우 가차없이 예외 프로그램 호출이다.
        - 예외 프로그램도 별도의 최대 호출 시간이 정해져 있다.

## 보호 모드

특권 모드에 가까워질수록 권한이 많은 것이다.

1. 워커 모드: 일반적인 프로세스를 실행하기 위한 모드.
    - 인터럽트 핸들러를 통해 권한 상승이 가능하다.
    - 호출자 정보 등 `Task` 메타데이터에 접근할 수 없다.
    - **Locality: 의존성 트리에 정의되지 않은 자식 프로세스를 생성/관리할 수 없다.**
        - 자식 프로세스의 관리는 엔트리 모드의 조상 프로세스가 대신한다.
1. 엔트리 모드: 호출자가 요구한 **의존성 트리**를 풀어내는 전용 모드.
    - 자신의 `Task` 메타데이터에 **읽기 전용**으로 접근할 수 있다.
        - 따라서, 호출자와 `Task` 정보를 조회 및 **상태 갱신**이 가능하므로, 호출자에게 `Task`의 상황을 보고하기 위한 별도의 작업이 가능하다.
    - **미리 승인받은 프로그램을 워커 모드로 동적으로 실행할 수 있다.**
        - 이를 통해 리소스를 절약하면서 의존성 트리를 풀어내고, 상태 갱신을 할 수 있다.
    - 엔트리 모드의 프로그램은 커널 외부에서 로드될 수 있다.
        - 인터럽트 모드와는 달리, 커널 컴파일 시에 정의되어야 한다.
1. 인터럽트 모드: 인터럽트 핸들러를 통해 커널이 생성하는 프로세스를 위한 모드.
    - 인터럽트 모드의 프로세스는 반드시 커널 밖에서 수행되어야 한다.
        - 커널이 직접 제어할 수 없는 I/O와 같은 기능을 구현할 수 있다.
        - 인터럽트 모드의 프로그램은 부팅 시에 정의되어야 한다.
            - 컴파일 시에 정의되어야 할 필요는 없다.
    - 인터럽트 모드는 반드시 엔트리 모드를 거쳐 커널의 제어에 따라 부여된다.
    - 비록 커널 밖에서 프로세스가 호출되지만 커널 자체에는 접근할 수 없다.
        - 물론, **이를 강제할 수는 없기 때문에 프로세스의 구현에 신중해야 한다.**
1. 커널 모드: 커널 자체를 제어하기 위한 모드.
    - 커널 모드는 반드시 커널 밖에서 요청되어야 한다.
        - 즉, 커널 내의 어떠한 프로세스도 특권 모드로 권한 상승을 꾀할 수 없다.
    - 커널 모드는 반드시 커널의 사용자만 요청할 수 있다.

## 인터럽트 모드

보호 모드와 별개로 인터럽트 자체 모드가 있다.
`보호 링` 의 개념과 유사하다고 보면 된다.
모든 인터럽트는 호출시 아래의 인터럽트 모드 중 하나를 선택해야 한다.
인터럽트 모드에 따라 리소스 접근 

1. 예약 프로그램 실행 요청: 의존성 트리에 실행이 약속된 요청이다.
    - 예약 프로그램은 부모 프로세스가 완료되기 전까지 반드시 요청되어야 한다.
    - **예약 프로그램의 의존성 트리를 동적으로 변경할 수 없다.**
    - 예) 주어진 파일을 다운로드하기
1. 자식 프로그램 실행 요청: 의존성 트리에 실행할 가능성이 약속된 요청이다.
    - 자식 프로그램의 실행 여부는 부모 프로세스가 결정할 수 있다.
    - **자식 프로그램의 의존성 트리의 값 부분을 동적으로 정의할 수 있다.**
    - 예) 배달로봇의 배송 시간이 지연되면 사용자에게 양해 메세지를 전송하기
1. 예외 프로그램 실행 요청: 의존성 트리에 대신 실행할 가능성이 약속된 요청이다.
    - 예외 프로그램은 부모 프로세스의 상태를 이어받아 실행될 수 있다.
    - 시간 초과로 호출되는 경우 **패널티**가 부여된다.
    - **예약 프로그램의 의존성 트리는 부모 프로세스와 공유한다.**
    - 예) 커피 배달 중 배달로봇의 예상치 못한 전원 공급 중단, 이에 대응할 솔루션을 수행하려는 경우
1. 중단 요청: 의존성 트리의 요청을 실패했음을 알리는 요청이다.
    - 프로세스가 제 역할에 실패한 것으로 **패널티**가 부여된다.
    - 만약 문제를 어떻게든 해결할 방법이 있어보인다면 차라리 낮은 단계의 인터럽트 모드를 일단 호출해보는 것이 낫다.
    - 예) 커피 배달 중 배달로봇의 예상치 못한 전원 공급 중단, 그리고 이에 대응할 솔루션 및 인력 또한 부재한 경우

## 런타임

커널이 `IPIIS` 를 통해 `Task` 를 동적으로 생성/관리할 수 있도록 부가 기능을 달은 일종의 데몬 프로그램이다.
사용자가 외부에서 접근할 수 있도록 `IPIIS` 인터페이스를 제공한다.

런타임은 커널 부팅 시 모듈을 추가할 수 있다.
이는 성능 향상을 위한 것으로, 특히 대용량 입출력이 요구되는 `IPNIS` , `IPSIS` 모듈 등을 필요시 추가할 수 있다.
모듈 형식으로 적용된 기능은 `syscall` 호출 시 `IPIIS` 모듈 대신 해당 모듈로 요청이 중개될 수 있다.

## 작동 예시

1. 어떤 프로그램을 실행하고자 한다.
    - 여기서 프로그램이란 빠르게 실행 가능한, 직렬화된 `WASI` 바이너리임.
1. 프로그램의 의존성 트리를 불러온다.
    - 의존성 트리: 여러 서브프로시저의 입출력 관계를 트리로 표현함.
1. 의존성 트리를 풀어낼 수 있는 프로그램을 생성한다.
    - 다른 프로그램들과의 차이점은, 의존성 트리 문제 해결을 위해 자기 자신 (Task)의 상태를 관측할 수 있음.
    - 즉, 다른 프로그램들과는 다르게 `호출자 정보` 등을 관측할 수 있는 `entry mode`로 실행함.
        - **이는 호출자가 커널의 소유자라도 적용된다.**
            - 커널은 그 자체로 완전해야 하므로 일반적인 방식으로는 제어할 수 없다.
            - `HLT` 등 커널 제어가 필요한 경우 **커널 외부에서 인증된 API를 통해 사용자 인증 후 커널 모드에서 제어할 수 있다.**
1. `어떤 경로`를 통해 프로그램을 로드한다.
    - `어떤 경로`의 예: Ipsis, Ipiis, Local, ...
1. 커널에게 의존성 트리를 해결해줄 것을 요청한다.
    - 호출자 계정, 프로그램, 의존성 트리 등을 제공한다.
    - **리소스가 감당 가능한지 검사한다.**
1. 작업을 시작하고, 호출자에게는 작업 ID를 반환한다.
    - Pull: 호출자는 주기적으로 작업이 완료되었는지를, 완료되었으면 그 결과값을 요청 (Poll)한다.
    - Push: 혹은, 런타임이 직접 **작업 상태를 보고할 수 있다.**
1. 만약 완료된 작업이 어떤 의존성 트리의 서브프로시저였다면, 어딘가에 있는 엔트리 프로세스가 다음 서브프로시저를 호출할 것이다.
